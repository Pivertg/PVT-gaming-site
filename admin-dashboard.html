export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const headers = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, DELETE, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type"
    };

    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers });
    }

    // Route pour créer un roster (POST /api/rosters)
    if (request.method === "POST" && url.pathname === "/api/rosters") {
      const rosterData = await request.json();
      await ROSTERS.put(rosterData.name, JSON.stringify(rosterData));
      return new Response("Roster créé avec succès", { status: 200, headers });
    }

    // Route pour ajouter un joueur à un roster spécifique (POST /api/rosters/{rosterName})
    if (request.method === "POST" && url.pathname.startsWith("/api/rosters/")) {
      const rosterName = url.pathname.split("/")[3]; // Extraire le nom du roster
      const joueurData = await request.json();
      const roster = await ROSTERS.get(rosterName);

      if (roster) {
        const rosterParsed = JSON.parse(roster);
        if (!rosterParsed.joueurs) {
          rosterParsed.joueurs = [];
        }
        rosterParsed.joueurs.push(joueurData);  // Ajouter le joueur au roster
        await ROSTERS.put(rosterName, JSON.stringify(rosterParsed));
        return new Response("Joueur ajouté avec succès", { status: 200, headers });
      }
      return new Response("Roster non trouvé", { status: 404, headers });
    }

    // Route pour récupérer tous les rosters (GET /api/rosters)
    if (request.method === "GET" && url.pathname === "/api/rosters") {
      const rosters = [];
      for await (const [key, value] of ROSTERS.list()) {
        const roster = JSON.parse(value);
        rosters.push(roster);
      }
      return new Response(JSON.stringify(rosters), { status: 200, headers });
    }

    // Route pour récupérer tous les joueurs (GET /api/joueurs)
    if (request.method === "GET" && url.pathname === "/api/joueurs") {
      const joueurs = [];
      for await (const [key, value] of JOUEURS.list()) {
        const joueur = JSON.parse(value);
        joueurs.push(joueur);
      }
      return new Response(JSON.stringify(joueurs), { status: 200, headers });
    }

    // Route pour ajouter un joueur (POST /api/joueurs)
    if (request.method === "POST" && url.pathname === "/api/joueurs") {
      const joueurData = await request.json();
      await JOUEURS.put(joueurData.brawlTag, JSON.stringify(joueurData));  // Utilise le BrawlTag comme clé unique
      return new Response("Joueur ajouté avec succès", { status: 200, headers });
    }

    // Route pour supprimer un joueur (DELETE /api/joueurs/{brawlTag})
    if (request.method === "DELETE" && url.pathname.startsWith("/api/joueurs/")) {
      const brawlTag = url.pathname.split("/")[3];  // Extraire le BrawlTag
      await JOUEURS.delete(brawlTag);  // Supprimer le joueur avec ce BrawlTag
      return new Response("Joueur supprimé avec succès", { status: 200, headers });
    }

    return new Response("Route non trouvée", { status: 404, headers });
  }
};
