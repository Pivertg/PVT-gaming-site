<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style-admin.css">
</head>
<body>
  <script>
    // Redirection si non connecté
    if (sessionStorage.getItem("adminToken") !== "adminLoggedIn") {
      window.location.href = "admin.html";
    }
  </script>

  <header style="background-color: #222; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
    <h1>Admin Dashboard</h1>
    <button onclick="logout()" style="padding: 0.5rem 1rem; background-color: #e74c3c; color: white; border: none; border-radius: 5px;">Déconnexion</button>
  </header>

  <main style="padding: 2rem;">
    <button onclick="ajouterRoster()" style="margin-bottom: 1rem; background-color: #27e5a2; color: black; padding: 10px 20px; font-size: 1rem; border: none; border-radius: 8px;">+ Ajouter un Roster</button>
    <div id="rosters-container"></div>
  </main>

  <script>
    const API_URL = "https://pvt-gaming-api.gamingpivert.workers.dev/api";

    function logout() {
      sessionStorage.removeItem("adminToken");
      window.location.href = "admin.html";
    }

    async function ajouterRoster() {
      const nom = prompt("Nom du roster :");
      if (!nom) return;

      const response = await fetch(`${API_URL}/rosters`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: nom })
      });

      if (response.ok) {
        for (let i = 1; i <= 3; i++) {
          await fetch(`${API_URL}/rosters/${encodeURIComponent(nom)}/joueurs`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pseudo: `Joueur ${i}`, brawlTag: "", trophées: 0, win3v3: 0, classement: 0, rangMax: 0 })
          });
        }
        chargerRosters();
      } else {
        alert("Erreur lors de la création du roster.");
      }
    }

    async function supprimerRoster(nom) {
      if (!confirm("Supprimer ce roster ?")) return;
      await fetch(`${API_URL}/rosters/${encodeURIComponent(nom)}`, { method: "DELETE" });
      chargerRosters();
    }

    async function modifierJoueur(rosterName, joueur) {
      const nouveauPseudo = prompt("Nouveau pseudo :", joueur.pseudo) || joueur.pseudo;
      const trophées = parseInt(prompt("Trophées :", joueur.trophées)) || joueur.trophées;
      const win3v3 = parseInt(prompt("Win 3v3 :", joueur.win3v3)) || joueur.win3v3;
      const classement = parseInt(prompt("Classement :", joueur.classement)) || joueur.classement;
      const rangMax = parseInt(prompt("Rang max :", joueur.rangMax)) || joueur.rangMax;

      await fetch(`${API_URL}/rosters/${encodeURIComponent(rosterName)}/joueurs/${joueur.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pseudo: nouveauPseudo, trophées, win3v3, classement, rangMax })
      });

      chargerRosters();
    }

    async function supprimerJoueur(rosterName, joueurId) {
      if (!confirm("Supprimer ce joueur ?")) return;
      await fetch(`${API_URL}/rosters/${encodeURIComponent(rosterName)}/joueurs/${joueurId}`, { method: "DELETE" });
      chargerRosters();
    }

    async function ajouterJoueur(rosterName) {
      const pseudo = prompt("Pseudo du joueur :");
      if (!pseudo) return;
      await fetch(`${API_URL}/rosters/${encodeURIComponent(rosterName)}/joueurs`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pseudo, brawlTag: "", trophées: 0, win3v3: 0, classement: 0, rangMax: 0 })
      });
      chargerRosters();
    }

    async function chargerRosters() {
      const container = document.getElementById("rosters-container");
      container.innerHTML = "";
      const response = await fetch(`${API_URL}/rosters`);
      const rosters = await response.json();

      for (const roster of rosters) {
        const joueursRes = await fetch(`${API_URL}/rosters/${encodeURIComponent(roster.name)}/joueurs`);
        const joueurs = await joueursRes.json();

        const rosterDiv = document.createElement("div");
        rosterDiv.style.border = "1px solid #ccc";
        rosterDiv.style.marginBottom = "2rem";
        rosterDiv.style.padding = "1rem";
        rosterDiv.style.borderRadius = "10px";
        rosterDiv.innerHTML = `
          <h2>${roster.name}</h2>
          <button onclick="ajouterJoueur('${roster.name}')" style="margin-bottom: 10px;">+ Ajouter joueur</button>
          <button onclick="supprimerRoster('${roster.name}')" style="background-color: red; color: white;">Supprimer le roster</button>
          <table border="1" style="width:100%; margin-top: 10px;">
            <thead>
              <tr>
                <th>Pseudo</th>
                <th>Trophées</th>
                <th>Win 3v3</th>
                <th>Classement</th>
                <th>Rang Max</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${joueurs.map(joueur => `
                <tr>
                  <td>${joueur.pseudo}</td>
                  <td>${joueur.trophées}</td>
                  <td>${joueur.win3v3}</td>
                  <td>${joueur.classement}</td>
                  <td>${joueur.rangMax}</td>
                  <td>
                    <button onclick='modifierJoueur("${roster.name}", ${JSON.stringify(joueur)})'>Modifier</button>
                    <button onclick='supprimerJoueur("${roster.name}", "${joueur.id}")'>Supprimer</button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;

        container.appendChild(rosterDiv);
      }
    }

    chargerRosters();
  </script>
</body>
</html>
