<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style-admin.css">
  <link rel="stylesheet" href="style-buttons.css">
</head>
<body>
  <script>
    // Redirection si non connect√©
    if (sessionStorage.getItem("adminToken") !== "adminLoggedIn") {
      window.location.href = "admin.html";
    }
  </script>

  <header style="background-color: #222; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
    <h1>Admin Dashboard</h1>
   <button onclick="sessionStorage.removeItem('adminToken'); window.location.href='admin.html';" style="padding: 0.5rem 1rem; background-color: #e74c3c; color: white; border: none; border-radius: 5px;">
   D√©connexion
   </button>
  </header>

  <main style="padding: 2rem;">
    <button onclick="ajouterRoster()" style="margin-bottom: 1rem; background-color: #27e5a2; color: black; padding: 10px 20px; font-size: 1rem; border: none; border-radius: 8px;">+ Ajouter un Roster</button>
    <div id="rosters-container"></div>

    <!-- Formulaire pour ajouter un roster -->
    <form id="form-creer-roster" style="display: none;">
      <input type="text" id="rosterName" placeholder="Nom du roster" required />
      <button type="submit">Cr√©er</button>
    </form>

    <!-- Formulaire pour ajouter un joueur -->
    <div id="form-ajouter-joueur-container" style="display: none;">
      <form id="form-ajouter-joueur">
        <input type="text" id="pseudo" placeholder="Pseudo du joueur" required />
        <input type="text" id="brawlTag" placeholder="Brawl Tag" required />
        <button type="submit">Ajouter le joueur</button>
      </form>
    </div>
  </main>

   <script>
  const API_URL = "https://pvt-gaming-api.gamingpivert.workers.dev/api";
  let currentRosterName = null;

  // V√©rification de connexion
  if (sessionStorage.getItem("adminToken") !== "adminLoggedIn") {
    window.location.href = "admin.html";
  }

  // Cr√©er un roster
  document.getElementById("form-creer-roster").addEventListener("submit", async function (event) {
    event.preventDefault();

    const rosterName = document.getElementById("rosterName").value.trim();

    try {
      const response = await fetch(`${API_URL}/rosters`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: rosterName })
      });

      if (!response.ok) throw new Error("Erreur lors de la cr√©ation du roster");

      alert("‚úÖ Roster cr√©√© !");
      document.getElementById("form-creer-roster").reset();
      loadRosters();

    } catch (err) {
      alert("‚ùå " + err.message);
    }
  });

  // Charger les rosters
  async function loadRosters() {
    try {
      const response = await fetch(`${API_URL}/rosters`);
      if (!response.ok) throw new Error("Erreur de r√©cup√©ration des rosters");

      const rosters = await response.json();
      const container = document.getElementById("rosters-container");
      container.innerHTML = '';

      rosters.forEach(roster => {
        const rosterDiv = document.createElement("div");
        rosterDiv.innerHTML = `
          <h3>${roster.name}</h3>
          <button onclick="selectRoster('${roster.name}')">üë• G√©rer Joueurs</button>
          <button onclick="deleteRoster('${roster.name}')">üóëÔ∏è Supprimer</button>
        `;
        container.appendChild(rosterDiv);
      });

    } catch (err) {
      console.error(err);
    }
  }

  // S√©lectionner un roster
  function selectRoster(rosterName) {
    currentRosterName = rosterName;
    document.getElementById("form-ajouter-joueur-container").style.display = "block";
    loadJoueurs(rosterName);
  }

  // Ajouter un joueur
  document.getElementById("form-ajouter-joueur").addEventListener("submit", async function (event) {
    event.preventDefault();

    const pseudo = document.getElementById("pseudo").value.trim();
    const brawlTag = document.getElementById("brawlTag").value.trim();

    try {
      const response = await fetch(`${API_URL}/rosters/${encodeURIComponent(currentRosterName)}/joueurs`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pseudo, brawlTag })
      });

      if (!response.ok) throw new Error("Erreur lors de l'ajout du joueur");

      alert("‚úÖ Joueur ajout√© !");
      document.getElementById("form-ajouter-joueur").reset();
      loadJoueurs(currentRosterName);

    } catch (err) {
      alert("‚ùå " + err.message);
    }
  });

  // Charger les joueurs d‚Äôun roster
  async function loadJoueurs(rosterName) {
    try {
      const response = await fetch(`${API_URL}/rosters/${encodeURIComponent(rosterName)}/joueurs`);

      if (!response.ok) {
        const msg = await response.text();
        console.warn("Requ√™te √©chou√©e :", msg);
        return;
      }

      const joueurs = await response.json();
      console.log("Joueurs de", rosterName, joueurs);
      // Affiche les joueurs si n√©cessaire

    } catch (err) {
      console.error("Erreur de chargement des joueurs :", err);
    }
  }

  // Supprimer un roster
  async function deleteRoster(rosterName) {
    if (!confirm(`Supprimer le roster "${rosterName}" ?`)) return;

    try {
      const response = await fetch(`${API_URL}/rosters/${encodeURIComponent(rosterName)}`, {
        method: "DELETE"
      });

      if (!response.ok) throw new Error("Erreur lors de la suppression du roster");

      alert("üóëÔ∏è Roster supprim√© !");
      loadRosters();

    } catch (err) {
      alert("‚ùå " + err.message);
    }
  }

  loadRosters();
</script>

</body>
</html>
