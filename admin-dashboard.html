<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style-admin.css">
</head>
<script>
    const API_URL = "https://pvt-gaming-api.gamingpivert.workers.dev/api/joueurs";
    const BRAWL_STARS_API = "https://api.brawlstars.com/v1";  // Remplace avec l'URL correcte pour l'API Brawl Stars

    // V√©rifie si l'administrateur est bien authentifi√©
    if (sessionStorage.getItem("adminToken") !== "adminLoggedIn") {
        alert("‚ùå Acc√®s refus√© ! Veuillez vous connecter.");
        window.location.href = "admin.html"; // Redirige vers la page de connexion
    }

    function logout() {
        sessionStorage.removeItem("adminToken"); // Supprime la session active
        alert("üëã D√©connexion r√©ussie !");
        window.location.href = "admin.html"; // Redirige vers la page de connexion
    }
</script>
<body>

    <div class="navbar">
        <h1>Dashboard</h1>
        <button onclick="logout()">üö™ Se d√©connecter</button>
    </div>

    <div class="add-roster">
        <input type="text" id="rosterName" placeholder="Nom du roster">
        <button onclick="ajouterRoster()">Ajouter Roster</button>
    </div>

    <div class="roster-container" id="rosterList"></div>

    <script>
        async function chargerRosters() {
            const response = await fetch(`${API_URL}`);
            const rosters = await response.json();
            const rosterList = document.getElementById("rosterList");
            rosterList.innerHTML = "";

            rosters.forEach(roster => {
                const div = document.createElement("div");
                div.classList.add("roster-card");
                div.innerHTML = `
                    <input type="text" class="editable" value="${roster.nom}" onblur="modifierRoster(${roster.id}, this.value)">
                    <button onclick="supprimerRoster(${roster.id})">‚ùå Supprimer</button>

                    <table>
                        <thead>
                            <tr>
                                <th>Pseudo</th>
                                <th>üèÜ Troph√©es</th>
                                <th>üèÖ Win 3V3</th>
                                <th>üìä Class√©</th>
                                <th>üîù Rang Max</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="joueurs-${roster.id}">
                        </tbody>
                    </table>

                    <div class="add-player">
                        <button onclick="ajouterJoueur(${roster.id})">+ Ajouter un joueur</button>
                    </div>
                `;

                rosterList.appendChild(div);
                afficherJoueurs(roster.id);
            });
        }

        async function ajouterJoueur(rosterId) {
            const tag = prompt("Entrez le tag Brawl Stars du joueur (par exemple : 'P8PPLR2')").trim();
            if (!tag) {
                alert("Le tag du joueur ne peut pas √™tre vide !");
                return;
            }

            const joueur = await recupererInfoBrawlStars(tag);
            if (joueur) {
                await fetch(`${API_URL}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        pseudo: joueur.name,
                        troph√©es: joueur.trophies,
                        win3v3: joueur.wins,
                        classement: joueur.rank,
                        rangMax: joueur.maxRank,
                        rosterId: rosterId
                    })
                });
                chargerRosters(); // Recharge la liste des rosters avec le joueur ajout√©
            }
        }

        async function recupererInfoBrawlStars(tag) {
            try {
                const response = await fetch(`${BRAWL_STARS_API}/players/${tag}`);
                if (!response.ok) throw new Error("Erreur API Brawl Stars");
                const data = await response.json();
                return {
                    name: data.name,
                    trophies: data.trophies,
                    wins: data.wins,
                    rank: data.rank,
                    maxRank: data.maxRank
                };
            } catch (error) {
                alert("‚ùå Impossible de r√©cup√©rer les informations Brawl Stars");
                console.error(error);
                return null;
            }
        }

        chargerRosters(); // Charger la liste des rosters √† chaque initialisation de la page
    </script>

</body>
</html>
