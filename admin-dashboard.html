export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const headers = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, DELETE, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type"
    };

    if (request.method === "OPTIONS") {
      return new Response(null, { status: 204, headers });
    }

    try {
      // Créer un roster
      if (request.method === "POST" && url.pathname === "/api/rosters") {
        const rosterData = await request.json();
        if (!rosterData.name) throw new Error("Nom de roster manquant");
        rosterData.joueurs = [];
        await env.ROSTERS.put(rosterData.name, JSON.stringify(rosterData));
        return new Response("Roster créé avec succès", { status: 200, headers });
      }

      // Ajouter un joueur à un roster
      if (request.method === "POST" && url.pathname.startsWith("/api/rosters/")) {
        const rosterName = decodeURIComponent(url.pathname.split("/")[3]);
        const joueurData = await request.json();
        const roster = await env.ROSTERS.get(rosterName);

        if (roster) {
          const rosterParsed = JSON.parse(roster);
          if (!rosterParsed.joueurs) rosterParsed.joueurs = [];
          rosterParsed.joueurs.push(joueurData);
          await env.ROSTERS.put(rosterName, JSON.stringify(rosterParsed));
          return new Response("Joueur ajouté avec succès", { status: 200, headers });
        }
        return new Response("Roster non trouvé", { status: 404, headers });
      }

      // Récupérer tous les rosters
      if (request.method === "GET" && url.pathname === "/api/rosters") {
        const rosters = [];
        const list = await env.ROSTERS.list();
        for (const key of list.keys) {
          const value = await env.ROSTERS.get(key.name);
          if (value) rosters.push(JSON.parse(value));
        }
        return new Response(JSON.stringify(rosters), { status: 200, headers });
      }

      // Récupérer tous les joueurs par roster
      if (request.method === "GET" && url.pathname === "/api/joueurs") {
        const joueursParRoster = {};
        const list = await env.JOUEURS.list();
        for (const key of list.keys) {
          const value = await env.JOUEURS.get(key.name);
          const joueur = JSON.parse(value);
          if (!joueursParRoster[joueur.roster]) joueursParRoster[joueur.roster] = [];
          joueursParRoster[joueur.roster].push(joueur);
        }
        return new Response(JSON.stringify(joueursParRoster), { status: 200, headers });
      }

      // Ajouter un joueur
      if (request.method === "POST" && url.pathname === "/api/joueurs") {
        const joueurData = await request.json();
        if (!joueurData.brawlTag || !joueurData.roster) throw new Error("Données manquantes");
        await env.JOUEURS.put(joueurData.brawlTag, JSON.stringify(joueurData));
        return new Response("Joueur ajouté avec succès", { status: 200, headers });
      }

      // Supprimer un joueur
      if (request.method === "DELETE" && url.pathname.startsWith("/api/joueurs/")) {
        const brawlTag = decodeURIComponent(url.pathname.split("/")[3]);
        await env.JOUEURS.delete(brawlTag);
        return new Response("Joueur supprimé avec succès", { status: 200, headers });
      }

      // Supprimer tous les rosters et leurs joueurs associés
      if (request.method === "DELETE" && url.pathname === "/api/rosters") {
        const list = await env.ROSTERS.list();
        for (const key of list.keys) {
          // Récupérer chaque roster pour supprimer ses joueurs
          const roster = await env.ROSTERS.get(key.name);
          if (roster) {
            const rosterParsed = JSON.parse(roster);
            if (rosterParsed.joueurs && rosterParsed.joueurs.length > 0) {
              // Supprimer tous les joueurs associés à ce roster
              for (const joueur of rosterParsed.joueurs) {
                await env.JOUEURS.delete(joueur.brawlTag); // Supprimer le joueur par son BrawlTag
              }
            }
          }
          await env.ROSTERS.delete(key.name); // Supprimer le roster
        }

        return new Response("Tous les rosters et leurs joueurs ont été supprimés.", { status: 200, headers });
      }

      // Supprimer un roster spécifique et ses joueurs associés
      if (request.method === "DELETE" && url.pathname.startsWith("/api/rosters/")) {
        const rosterName = decodeURIComponent(url.pathname.split("/")[3]);
        const roster = await env.ROSTERS.get(rosterName);

        if (roster) {
          const rosterParsed = JSON.parse(roster);
          if (rosterParsed.joueurs && rosterParsed.joueurs.length > 0) {
            // Supprimer tous les joueurs associés à ce roster
            for (const joueur of rosterParsed.joueurs) {
              await env.JOUEURS.delete(joueur.brawlTag); // Supprimer le joueur par son BrawlTag
            }
          }
          // Supprimer le roster
          await env.ROSTERS.delete(rosterName);
          return new Response(`Roster ${rosterName} et ses joueurs ont été supprimés.`, { status: 200, headers });
        }
        return new Response("Roster non trouvé", { status: 404, headers });
      }

      return new Response("Route non trouvée", { status: 404, headers });
    } catch (error) {
      return new Response("Erreur interne : " + error.message, { status: 500, headers });
    }
  }
};
